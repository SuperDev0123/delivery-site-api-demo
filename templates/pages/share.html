{% extends 'layouts/base.html' %}
{% block title %} : Home {% endblock %}
{% load static %}
{% block content %}
    <div class="container h-100vh">
    	<div class="row justify-content-md-center mt-5 mb-5">
    		<div class="col-12">
    			<form action="/share/upload/" class="dropzone" id="uploadDropzone">
    				{% csrf_token %}
    				<select id="warehouse" required>
	    				<option value="">Select a warehouse</option>
	    				{% for warehouse in warehouses %}
	    					<option value={{warehouse.pk_id_client_warehouse}}>{{warehouse.warehousename}}</option>
	    				{% endfor %}
	    			</select>
    				<button id="submit-upload" type="submit">upload</button>
    			</form>
        	</div>
        	<div class="col-12">
        		<p id="upload-status"></p>
        		<p id="upload-filename"></p>
        	</div>
        </div>
    </div>
{% endblock %}  
{% block extra_css_lib %}
	<link rel="stylesheet" href="{% static '/js/libs/dropzone/dropzone.css' %}">
{% endblock %}
{% block extra_js %}
	<script src="{% static '/js/libs/dropzone/dropzone.js' %}"></script>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script>
		var filename = "";

		Dropzone.options.uploadDropzone = {
			paramName: "file", 	// The name that will be used to transfer the file,
			maxFilesize: 250, 	// MB
			autoProcessQueue: false,
			accept: function(file, done) {
				console.log(file.name);
				filename = file.name;
				done();
			},
			init: function() {
				var myDropzone = this,
        		submitButton = document.querySelector("[type=submit]");

        		submitButton.addEventListener('click', function(e) {
        			var isValid = document.querySelector('#warehouse').reportValidity();
			        e.preventDefault();
			        e.stopPropagation();
			        if (isValid)
			        	myDropzone.processQueue();
			    });

			    this.on('sending', function(data, xhr, formData) {
			    	formData.append("warehouse_id", jQuery("#warehouse option:selected").val());
			    });

				this.on("success", function(file) { 
					var myInterval = setInterval(myTimer, 2000);

					function myTimer() {
					    $.ajax({
						  url: "/share/upload/status/",
						  data: {filename: filename}
						}).done(function(res) {
						  if (res.status_code === 0) {
						  	$("p#upload-status").text("Checking file(" + file.xhr.response + ")");
						  } else if (res.status_code === 1) {
						  	$("p#upload-status").text("Successfully uploaded!");
						  } else if (res.status_code === 2) {
						  	let errors = res.errors;
						  	$("p#upload-status").text("There are some error(s) while uploading. Please fix out and upload again.");

						  	for (let i = 0; i < errors.length; i++)
						  		$("p#upload-status").append("<p>" + errors[i] + "</p>");
						  }

						  if (res.status_code !== 0)
						  	myStopFunction();
						});
					}

					function myStopFunction() {
					    clearInterval(myInterval);
					} 

					$("p#upload-filename").text("Upload a file with prepend filename: " + file.xhr.response);
				});
			}
		};
	</script>
{% endblock %}  